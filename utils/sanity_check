#!/bin/sh
#
# sanity_check -- general sanity checker for the source and translations
#

# This had better take us to the top-level source directory.  
# Otherwise, confusion will ensue. 
cd ..
if [ `basename $PWD` != 'wesnoth' ]
then
	echo "sanity_check: " \
		"this tool must be run from the Wesnoth utils directory."
	exit 1
fi
problems=no

# First sanity check:

echo "Checking POTFILES correctness..."

potfiles="po/wesnoth/POTFILES.in po/wesnoth-lib/POTFILES.in po/wesnoth-editor/POTFILES.in"

# Gather the list of sources
find src -name '*.cpp' -print | sort >/tmp/sschk$$_sources
# See what's in the POTFILES
sort -u $potfiles >/tmp/sschk$$_potmembers
# Figure out which sources are not listed but should be
missing=`comm -23 /tmp/sschk$$_sources /tmp/sschk$$_potmembers | tr '\012' ' '`
# Find invalid potfile entries
invalid=`comm -13 /tmp/sschk$$_sources /tmp/sschk$$_potmembers | tr '\012' ' '`
if [ $missing ]
then
    echo "  Missing from the POTFILE.in files: $missing"
    problems=yes
else
    echo "  All .cpp files have POTFILE.in entries." 
fi 
if [ $invalid ]
then
    echo "  Invalid POTFILE entries: $invalid"
    problems=yes
else
    echo "  All POTFILE.in entries are valid." 
fi

# Check for duplicates
sort $potfiles >/tmp/sschk$$_potsorted
duplicates=`comm -23 /tmp/sschk$$_potsorted /tmp/sschk$$_potmembers | tr '\012' ' '`
if [ $duplicates ]
then
	echo "  Duplicates within the entire POTFILES set: $duplicates"
	problems=yes
fi

for file in po/wesnoth/POTFILES.in po/wesnoth-lib/POTFILES.in po/wesnoth-editor/POTFILES.in
do
	sort $file >/tmp/sschk$$_sorted
	sort -u $file >/tmp/sschk$$_uniq
	duplicates=`comm -23 /tmp/sschk$$_sorted /tmp/sschk$$_uniq | tr '\012' ' '`
	if [ $duplicates ]
	then
		echo "  Duplicates within $file: $duplicates"
		problems=yes
	fi
done

# Check on the editor subdirectory
find src/editor -name '*.cpp' -print | sort >/tmp/sschk$$_sources
# See what's in the POTFILES
sort -u po/wesnoth-editor/POTFILES.in >/tmp/sschk$$_potmembers
# Figure out which sources are not listed but should be
missing=`comm -23 /tmp/sschk$$_sources /tmp/sschk$$_potmembers | tr '\012' ' '`
# Find invalid potfile entries
invalid=`comm -13 /tmp/sschk$$_sources /tmp/sschk$$_potmembers | tr '\012' ' '`
if [ $missing ]
then
    echo "  Missing from the editor POTFILE.in: $missing"
    problems=yes
else
    echo "  All editor .cpp files have po/wesnoth-editor/POTFILE.in entries." 
fi 
if [ $invalid ]
then
    echo "  Invalid po/wesnoth-editor/POTFILE.in entries: $invalid"
    problems=yes
else
    echo "  All po/wesnoth-editor/POTFILE.in entries are valid." 
fi

# More sanity checks can go here...

# Cleanup
if [ $problems = 'no' ]
then
	echo "All sanity checks passed."
fi

rm /tmp/sschk$$_*
