#textdomain wesnoth-utbs

# This module is used to handle all events within the oasis boundary. This includes finding all the elves that we 
# have to rescue, dealing with mudcrawlers and lake monster. 
#! -- Depends on
# $rescued_elves, $seen_mudcrawler
 
# North-West mudcrawler/villager encounter
# Elvish fighter and 2 archers fighting
# Easy: 1 giant mudcrawler, 3 small mudcrawlers
# Medium: 2 giant mudcrawlers, 2 small mudcrawlers
# Hard: 3 giant mudcrawlers, 1 small mudcrawler

	[event]
		name=moveto
		[filter]
			x=17-26
			y=23-28
			side=1
		[/filter]

		{VARIABLE_OP rescued_elves add 1}
	# Place found elves, this schema will repeat over this module as I want to use core macros (which saves maintenance
	# burden) and have them posses both random traits and loyal.
		{LOYAL_UNIT	"Desert Fighter" "Vecnu" ( _ "Vecnu") 1 24 25}
		[+unit]
			random_traits=yes
		[/unit]
        {LOYAL_UNIT "Desert Archer"	"Eranor" ( _ "Eranor") 1 24 27}
		[+unit]
			random_traits=yes
		[/unit]
        {LOYAL_UNIT "Desert Archer"	"Seela"	( _ "Seela") 1 21 25}
		[+unit]
			random_traits=yes
			gender=female
		[/unit]
		
	# Again core macro, monsters shouldn't have traits 
		{NOTRAIT_UNIT "Giant Mudcrawler" "Mud monster" (_ "Mud monster") 2 20 24}

		#ifdef HARD
			{NOTRAIT_UNIT "Giant Mudcrawler" "Mud monster" (_ "Mud monster") 2 20 25}
		#else
			{NOTRAIT_UNIT "Small Mudcrawler" "Mud monster" (_ "Mud monster") 2 20 25}
		#endif
		#ifdef EASY
			{NOTRAIT_UNIT "Small Mudcrawler" "Mud monster" (_ "Mud monster") 2 23 27}
			{NOTRAIT_UNIT "Small Mudcrawler" "Mud monster" (_ "Mud monster") 2 25 28}
		#else
			{NOTRAIT_UNIT "Giant Mudcrawler" "Mud monster" (_ "Mud monster") 2 23 27}
			{NOTRAIT_UNIT "Small Mudcrawler" "Mud monster" (_ "Mud monster") 2 24 28}
		#endif

		[if]
			[variable]
				name=seen_mudcrawler
				equals=no
			[/variable]
			[then]
		
			# Haven't seen a mudcrawler yet, set the flag and perform what-the-hell-is-that routine.

				{VARIABLE seen_mudcrawler yes}
				[message]
					description=Vecnu
					message= _ "Kaleh, Nym, help us!"
				[/message]
				[message]
					description=Nym
					message= _ "What in Uria's name is that?"
				[/message]
				[message]
					description=Vecnu
					message= _ "They came with the stones that fell from the sky. I know not what they are, but more seem to be emerging from the craters. If we don't stop them there will be nothing left of our village or our people."
				[/message]
				[message]
					description=Kaleh
					message= _ "To battle, my friends! There are still those left who can fight."
				[/message]
			[/then]
			[else]
		
			# Seen a mudcrawler, do let's-kick-their-ass routine
				[message]
					description=Kaleh
					message= _ "There are more of our people fighting the mud monsters!"
				[/message]
				[message]
					description=Nym
					message= _ "Then let's join the battle!"
				[/message]
			[/else]
		[/if]
	[/event]
	
# South-West mudcrawler/villager encounter
# Elvish archer and 2 hunters fighting
# Easy: 1 giant mudcrawler, 3 small mudcrawlers
# Medium: 2 giant mudcrawlers, 2 small mudcrawlers
# Hard: 3 giant mudcrawlers, 1 small mudcrawler
	[event]
		name=moveto
		[filter]
			x=17-28
			y=29-36
			side=1
		[/filter]

		{VARIABLE_OP rescued_elves add 1}
		{LOYAL_UNIT "Desert Hunter" "Eloshi" ( _ "Eloshi") 1 24 34}
		[+unit]
			random_traits=yes
		[/unit]
		{LOYAL_UNIT "Desert Archer" "Illuvia" ( _ "Illuvia") 1 19 33}
		[+unit]
			random_traits=yes
			gender=female
		[/unit]
        {LOYAL_UNIT "Desert Hunter" "Raynor" ( _ "Raynor") 1 21 35}
		[+unit]
			random_traits=yes
		[/unit]

		{NOTRAIT_UNIT "Giant Mudcrawler" "Mud monster" (_ "Mud monster") 2 25 34}
        {NOTRAIT_UNIT "Small Mudcrawler" "Mud monster" (_ "Mud monster") 2 21 36}
		#ifdef HARD
			{NOTRAIT_UNIT "Giant Mudcrawler" "Mud monster" (_ "Mud monster") 2 24 35}
		#else
			{NOTRAIT_UNIT "Small Mudcrawler" "Mud monster" (_ "Mud monster") 2 24 35}
		#endif
		#ifdef EASY
			{NOTRAIT_UNIT "Small Mudcrawler" "Mud monster" (_ "Mud monster") 2 20 34}
		#else
			{NOTRAIT_UNIT "Giant Mudcrawler" "Mud monster" (_ "Mud monster") 2 20 34}
		#endif

		[message]
			description=Kaleh
			message=_ "More of these muddy crawlies, let's get rid of them with haste."
		[/message]
	[/event]

# Training ground encounter
# Easy: 2 giant mudcrawler, 3 small mudcrawlers
# Medium: 3 giant mudcrawlers, 2 small mudcrawlers
# Hard: 4 giant mudcrawlers, 1 small mudcrawlers
	[event]
		name=moveto
		[filter]
			x=32-39
			y=32-36
			side=1
		[/filter]

	# We want this village captured to allow player move trough it without loosing the turn
		[capture_village]
			side=1
			x,y=36,34
		[/capture_village]

		{ADD rescued_elves 1}

		{NOTRAIT_UNIT "Giant Mudcrawler" "Rocky Horror" ( _ "Rocky Horror") 2 34 33}
		{NOTRAIT_UNIT "Giant Mudcrawler" "Rocky Horror" ( _ "Rocky Horror") 2 34 34}
		{NOTRAIT_UNIT "Small Mudcrawler" "Rocky Horror" ( _ "Rocky Horror") 2 34 35}
		#ifdef HARD
			{NOTRAIT_UNIT "Giant Mudcrawler" "Rocky Horror" ( _ "Rocky Horror") 2 35 33}
		#else
			{NOTRAIT_UNIT "Small Mudcrawler" "Rocky Horror" ( _ "Rocky Horror") 2 35 33}
		#endif
		#ifdef EASY
			{NOTRAIT_UNIT "Small Mudcrawler" "Rocky Horror" ( _ "Rocky Horror") 2 36 32}
		#else
			{NOTRAIT_UNIT "Giant Mudcrawler" "Rocky Horror" ( _ "Rocky Horror") 2 36 32}
		#endif

		[unit]
			type=Desert Captain
			description=Garak
			user_description= _ "Garak"
			profile=portraits/garak.png
			x=35
			y=34
			side=1
			[modifications]
				{TRAIT_STRONG}
				{TRAIT_LOYAL}
				[object]
					[effect]
						apply_to=attack
						range=ranged
						increase_damage=1
					[/effect]
				[/object]
			[/modifications]
			{IS_HERO}
		[/unit]

		{LOYAL_UNIT "Desert Fighter" "Jorazan" ( _ "Jorazan") 1 36 33}
		[+unit]
			random_traits=yes
		[/unit]
		{LOYAL_UNIT "Desert Fighter" "Zyara" ( _ "Zyara") 1 35 35}
		[+unit]
			gender=female
			random_traits=yes
		[/unit]

		[message]
			speaker=unit
			message= _ "This is our training ground. And look, there is Garak, the captain of the guard. He and his fighters have survived the night!"
		[/message]
		[if]
			[variable]
				name=seen_mudcrawler
				equals=no
			[/variable]
			[then]
			# Again, haven't seen a mudcrawler yet, set the flag and perform what-the-hell-is-that routine.
				{VARIABLE seen_mudcrawler yes}
				[message]
					description=Garak
					message= _ "Kaleh, Nym, help us!"
				[/message]
				[message]
					description=Nym
					message= _ "What in Uria's name is that?"
				[/message]
				[message]
					description=Garak
					message= _ "They came with the stones that fell from the sky. I know not what they are, but more seem to be emerging from the craters. If we don't stop them there will be nothing left of our village or our people."
				[/message]
				[message]
					description=Kaleh
					message= _ "To battle, my friends! There are still those left who can fight."
				[/message]
			[/then]
			[else]
				[message]
					description=Kaleh
					message= _ "But they are fighting many mud creatures. Quick, we must help them!"
				[/message]
			[/else]
		[/if]

	# Garak's speech when they kill the last of training grounds mudcrawlers. For this we use die event
	# that on each occurence checks if there are any more training ground mudcrawlers alive.

		[event]
			name=die
			first_time_only=no
			[filter]
				description="Rocky Horror"
			[/filter]

			[if]
				[not]
					[have_unit]
						description="Rocky Horror"
					[/have_unit]
				[/not]
				[then]
					[message]
						speaker=second_unit
						message= _ "Ha! They're destroyed at last."
					[/message]
					[message]
						speaker=Garak
						message= _ "Thanks for the help. I am glad to see that so many have survived the night. But there's no time to talk, we must save the rest of our people and crush any other of these earthen abominations back into the earth."
					[/message]
				[/then]
			[/if]
		[/event]
	[/event]

# The following three events are nested, because they are supposed to occur in that particular sequence with none of them bypassed.
# Thanks to this only one of them is loaded in memory at any given time before resolution.	

# Approaching bridge dialogue
	[event]
		name=moveto
		[filter]
			x=30-32
			y=29-35
			side=1
		[/filter]

	# That's supposed to allow to undo the move before the event is triggered
		[allow_undo]
		[/allow_undo]

		[message]
			speaker=Kaleh
			message= _ "This bridge leads to the holy island at the center of our lake."
		[/message]
		[message]
			speaker=Nym
			message= _ "Hmmmm. Some of the druids that worship on the island may still be alive. We should go check."
		[/message]
		[message]
			speaker=Kaleh
			message= _ "Be careful. The bridge is broken, so we'll have to wade through the shallow water."
		[/message]

	# Finding druids
		[event]
			name=moveto
			[filter]
				x=30-32
				y=27-29
				side=1
			[/filter]
			
			{ADD rescued_elves 1}
			[message]
				speaker=Kaleh
				message= _ "The great tree! It has been buried under the rocks. Our most holy sanctuary, defiled. Oh, Eloh, what shall we do?"
			[/message]
			[message]
				speaker=Nym
				message= _ "Is anyone still alive?"
			[/message]
			[unit]
				type=Desert Druid
				description=Zhul
				user_description= _ "Zhul"
				profile=portraits/zhul.png
				x=31
				y=27
				side=1
				[modifications]
					{TRAIT_QUICK}
					{TRAIT_INTELLIGENT}
					{TRAIT_LOYAL}
				[/modifications]
				{IS_HERO}
			[/unit]
			{LOYAL_UNIT "Desert Shaman" "Ryoko" ( _ "Ryoko") 1 30 27}
			[+unit]
				random_traits=yes
			[/unit]
			{LOYAL_UNIT "Desert Shaman" "Yuni" ( _ "Yuni") 1 32 27}
			[+unit]
				random_traits=yes
			[/unit]
			[message]
				speaker=Zhul
				message= _ "Finally! We were worried that no one else had survived."
			[/message]
			[message]
				speaker=Nym
				message= _ "Mother priestess, are you all right?"
			[/message]
			[message]
				speaker=Zhul
				message= _ "There's no time to stand on ceremony. I'm fine. I'm afraid only a few of us survived, but we will lend you what skills we have. Show me to those who need healing."
			[/message]
			[message]
				speaker=Kaleh
				message= _ "But the great tree, it has been destroyed!"
			[/message]
			[message]
				speaker=Zhul
				message= _ "All things of this world come to an end, but the power of Eloh endures. A new one shall grow in its place. Come now, let us see to the needs of our people."
			[/message]

		#Lake monster event
		
			[event]
				name=moveto
				[filter]
					x=30-32
					y=30-34
					side=1
				[/filter]
				
				[unit]
					type=Cuttle Fish
					description="Deep One"
					user_description=_"Deep One"
					unit_description= _ "The Deep Ones are gigantic aquatic monsters that lurk in the dark places of the world. Rarely do they come to the surface, and when they do the best way to survive an encounter with these monsters is to remain ashore. They can grab their opponents with strong tentacles, or spit a poisonous black ink from a distance."
                # Deep one is basicaly a weakened Cuttle fish, it would be pretty much unbeatable if left without change
					[modifications]
						[trait]
							id=Deep_one
							[effect]
								apply_to=attack
								range=melee
								increase_attacks=-4
							[/effect]
							[effect]
								apply_to=hitpoints
								increase_total=-27
							[/effect]
							#ifndef HARD
								[effect]
									apply_to=defense
									replace=yes
									[defense]
										shallow_water=50
									[/defense]
								[/effect]
							#endif
						[/trait]
					[/modifications]
					x=32
					y=30
					side=2
				[/unit]
				[message]
					speaker=narrator
					message= _ "The water of the lake suddenly goes dark and unsettled, only to erupt in a swarm of tentacles in the moment first elf put a foot outside the island."
				[/message]
				[message]
					speaker=Nym
					message= _ "What in Uria's name is that?"
				[/message]
				[message]
					speaker=Zhul
					message= _ "I felt a great darkness in this lake, but I knew not what it was. The falling rocks must have woken it from its sleep."
				[/message]
				[message]
					speaker=Kaleh
					message= _ "Protect the priestesses, we shall send this monstrosity back to the depths it came from!"
				[/message]
			[/event]
		[/event]
	[/event]

# Grasslands dialogue, when Kaleh and Nym approach the eastern fields, this will show only the first time 
# player enters the stables area

	[event]
		name=moveto
		[filter]
			x=39-44
			y=26-33
			side=1
		[/filter]
        {ADD rescued_elves 1}
		[message]
			description=Kaleh
			message= _ "These fields seem strangely vacant. Where are the horses?"
		[/message]
		[message]
			description=Nym
			message= _ "Maybe they're hiding in the stables. Let's go check."
		[/message]
	[/event]

# These two events actually do the same thing on two different villages, it might be not the most efficient
# way of doing thing when considering code lenght, but it saves us some macro abuse and akward capture checks
    [event]
		name=capture
		[filter]
			x=43
			y=29
			side=1
		[/filter]

	# Captured stables and found a scout, if have none of the pair spawn Naru
		[if]
			[have_unit]
				description=Naru
			[/have_unit]
			[then]
				[message]
					description=Naru
					message= _ "Hey Nisa, the rocks have stopped falling. You can come out now!"
				[/message]
				{LOYAL_UNIT "Desert Scout" "Nisa" (_"Nisa") 1 $x1 $y1}
				[+unit]
					gender=female
					random_traits=yes
				[/unit]
				[message]
					description=Nisa
					message= _ "Oh, thank Eloh, I thought they would never stop."
				[/message]
			[/then]
		# If have naru spawn Nisa
			[else]
				{LOYAL_UNIT "Desert Scout" "Naru" (_"Naru") 1 $x1 $y1}
				[+unit]
					random_traits=yes
				[/unit]
				[message]
					description=Naru
					message= _ "Is it safe to come out? I was so scared."
				[/message]
				[message]
					description=Kaleh
					message= _ "Where are all the other horses?"
				[/message]
				[message]
					description=Naru
					message= _ "A hunting party left just yesterday, so unless the rocks fell all over the land, many of the horses have probably survived. The few that remained here were scared by the falling rocks and fled into the night. It took all my skill to calm Yasi and keep him from running."
				[/message]
				[message]
					description=Kaleh
					message= _ "We'll need your help in checking to see if the outer settlements are okay. Who knows what kinds of damage they suffered in the night? And perhaps some of the people out in the desert have been able to round up some of the loose horses."
				[/message]
				[message]
					description=Nym
					message= _ "Well, let's hope that hunting party comes back soon."
				[/message]
			[/else]
		[/if]
    [/event]

    [event]
		name=capture
		[filter]
			x=43
			y=32
			side=1
		[/filter]

		[if]
			[have_unit]
				description=Naru
			[/have_unit]
			[then]
				[message]
					description=Naru
					message= _ "Hey Nisa, the rocks have stopped falling. You can come out now!"
				[/message]
				{LOYAL_UNIT "Desert Scout" "Nisa" (_"Nisa") 1 $x1 $y1}
				[+unit]
					gender=female
					random_traits=yes
				[/unit]
				[message]
					description=Nisa
					message= _ "Oh, thank Eloh, I thought they would never stop."
				[/message]
			[/then]
			[else]
				{LOYAL_UNIT "Desert Scout" "Naru" (_"Naru") 1 $x1 $y1}
				[+unit]
					random_traits=yes
				[/unit]
				[message]
					description=Naru
					message= _ "Is it safe to come out? I was so scared."
				[/message]
				[message]
					description=Kaleh
					message= _ "Where are all the other horses?"
				[/message]
				[message]
					description=Naru
					message= _ "A hunting party left just yesterday, so unless the rocks fell all over the land, many of the horses have probably survived. The few that remained here were scared by the falling rocks and fled into the night. It took all my skill to calm Yasi and keep him from running."
				[/message]
				[message]
					description=Kaleh
					message= _ "We'll need your help in checking to see if the outer settlements are okay. Who knows what kinds of damage they suffered in the night? And perhaps some of the people out in the desert have been able to round up some of the loose horses."
				[/message]
				[message]
					description=Nym
					message= _ "Well, let's hope that hunting party comes back soon."
				[/message]
			[/else]
		[/if]
    [/event]
	

