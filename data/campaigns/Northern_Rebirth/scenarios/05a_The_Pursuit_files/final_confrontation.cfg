#textdomain wesnoth-nr

# This event handles the opening of the doors to the malifors study. Since there are three pairs of them and player can choose not
# to open them immediately it's somewhat complicated and long.
    [event]
        name=moveto
        first_time_only=no
	# The doors can be opened from following coordinates : spider (23,6), main [(21,9) (21,10) (21,11)], back (28,12)
        [filter]
            side=1
            x=23,28,21,21,21
            y=6,12,9,10,11
        [/filter]

	# This variable will tell us wether player decided to open the door, initialy set to no 
		{VARIABLE open_the_door no}
        [if]
		# If we're at spider door (y==6) and they're still colsed
            [variable]
                name=spider_door_opened
                equals=no
            [/variable]
			[variable]
				name=y1
				equals=6
			[/variable]
		# Give the player option to open them
			[then]
                [message]
                    speaker=unit
                    message= _ "Hmmm, another door. Boy, is this one sure locked up."
                [/message]
                [message]
                    speaker=Tallin
                    message= _ "Anything you can't handle?"
                [/message]
                [message]
                    speaker=unit
                    message= _ "Nope. Should I open it?"
                    [option]
                        message= _ "Go for it!"
                        [command]
                            [message]
                                speaker=narrator
                                message= _ " *CRASH*"
                                image=misc/empty.png	# Stop wmllint from inserting Wesnoth logo
                            [/message]
                            [terrain]
                                x=23
                                y=7
                                terrain=Uu
                            [/terrain]
						# Set the flags for future reference, player decided to open a door and it was the spider one
							{VARIABLE open_the_door yes}
							{VARIABLE spider_door_opened yes}
                            [message]
                                speaker=unit
                                message= _ "There we go."
                            [/message]
						[/command]
                    [/option]
                    [option]
                        message= _ "Just wait a sec."
                        [command]
                            [message]
                                speaker=unit
                                message= _ "Very well."
                            [/message]
                        [/command]
                    [/option]
                [/message]
			[/then]
		[/if]
		[if]
		# If we're at the main door (8<y<12) and the door are closed
			[variable]
				name=main_door_opened
				equals=no
			[/variable]			
			[variable]
				name=y1
				greater_than=8
			[/variable]
			[variable]
				name=y1
				less_than=12
			[/variable]
			[then]
                [message]
                    speaker=unit
                    message= _ "It looks like this is it. Here is the door to Malifor's study. Are we all ready for this?"
                    [option]
                        message= _ "Yeah, open those doors!"
                        [command]
							{VARIABLE open_the_door yes}
							{VARIABLE main_door_opened yes}
							[message]
                                speaker=narrator
                                message= _ " *CRASH*"
                                image=misc/empty.png	# Stop wmllint from inserting a logo here
                            [/message]
                            [terrain]
                                x=22,22
                                y=9,10
                                terrain=Uu
                            [/terrain]
                            [message]
                                speaker=unit
                                message= _ "There we go."
                            [/message]
                        [/command]
                    [/option]
                    [option]
                        message= _ "Just wait a sec."
                        [command]
                            [message]
                                speaker=unit
                                message= _ "Very well."
                            [/message]
                        [/command]
                    [/option]
                [/message]
			[/then]
		[/if]
	# If we're at the back door (y==28) and they're closed
		[if]
			[variable]
				name=back_door_opened
				equals=no
			[/variable]
			[variable]
				name=y1
				equals=12
			[/variable]
			[then]
                [message]
                    speaker=unit
                    message= _ "Hey, check this out, it looks like some sort of lever."
                [/message]
                [message]
                    speaker=Tallin
                    message= _ "Probably for that door right there."
                [/message]
                [message]
                    speaker=unit
                    message= _ "Should I throw it?"
                    [option]
                        message= _ "Go for it!"
                        [command]
							{VARIABLE open_the_door yes}
							{VARIABLE back_door_opened yes}
                            [message]
                                speaker=unit
                                message= _ "Ok, here we go!"
                            [/message]
                            [message]
                                speaker=unit
                                message= _ " *creak*....."
                            [/message]
                            [message]
                                speaker=unit
                                message= _ "Nothing. That door is not moving."
                            [/message]
                            [message]
                                speaker=Tallin
                                message= _ "Why don't you try 'knocking'."
                            [/message]
                            [message]
                                speaker=unit
                                message= _ "Ok."
                            [/message]
                            [message]
                                speaker=unit
                                message= _ " *BANG*"
                            [/message]
                            [message]
                                speaker=unit
                                message= _ "Anybody home?"
                            [/message]
                            [message]
                                speaker=unit
                                message= _ " *BOOM*"
                            [/message]
                            [message]
                                speaker=unit
                                message= _ " *CRASH!!!*"
                            [/message]
                            [terrain]
                                x=27
                                y=13
                                terrain=Uu
                            [/terrain]
                            [message]
                                speaker=unit
                                message= _ "There we go."
                            [/message]
                        [/command]
                    [/option]
                    [option]
                        message= _ "Just wait a sec."
                        [command]
                            [message]
                                speaker=unit
                                message= _ "Very well."
                            [/message]
                        [/command]
                    [/option]
                [/message]
			[/then]
		[/if]
	# Now opening the door will trigger confrontation with malifor if it didn't happen yet. For this reason we check if player 
	# decided to open one, and if that confrontation taken place yet
		[if]
			[variable]
				name=open_the_door
				equals=yes
			[/variable]
            [variable]
                name=confronted_malifor
                equals=no
            [/variable]
            [then]
			# Set a flag to prevent the confrontation form getting triggered more than once
				{VARIABLE confronted_malifor yes}
				[remove_shroud]
                    x=23-26
                    y=8-13
                [/remove_shroud]
                [message]
                    speaker=Malifor
                    message= _ "You wretched vermin, I have had it with you! Guards!"
                [/message]
			# Give malifor 4 guards and 150 gold at Newbie
                {NOTRAIT_UNIT 2 Deathblade 25 11}
                {NOTRAIT_UNIT 2 Deathblade 25 11}
                {NOTRAIT_UNIT 2 Lich 25 11}
                {NOTRAIT_UNIT 2 Lich 25 11}
                [gold]
                    side=2
                    amount=150
                [/gold]
				# 6 guards and 200 gold at Easy
				#ifndef NEWBIE
                    {NOTRAIT_UNIT 2 Deathblade 25 11}
                    {NOTRAIT_UNIT 2 Lich 25 11}
                    [gold]
                        side=2
                        amount=50
                    [/gold]
					# 8 guards and 300 gold at Normal
					#ifndef EASY
						{NOTRAIT_UNIT 2 Deathblade 25 11}
						{NOTRAIT_UNIT 2 Lich 25 11}
						[gold]
							side=2
							amount=100
						[/gold]
						# 10 guards and 400 gold at Hard
						#ifndef NORMAL
							{NOTRAIT_UNIT 2 Deathblade 25 11}
							{NOTRAIT_UNIT 2 Lich 25 11}
							[gold]
								side=2
								amount=100
							[/gold]
						#endif
					#endif
				#endif
				[message]
					speaker=Malifor
					message= _ "You invaded my kingdom, drove me from my mines, raided my dungeon, and plundered my treasury Your audacity ends here!"
				[/message]
			# Second malifor line doesn't have sense without at least one White Mage around, for this reason we need to check for their presence.
			# I'm not assuming that they might die before, but they might not have been freed at this point.
				[if]
					[have_unit]
						id=Father Marcus
					[/have_unit]
					[or]
						[have_unit]
							id=Sister Theta
						[/have_unit]
					[/or]
					[then]
						[message]
							speaker=Father Marcus
							message= _ "You are wrong, Malifor, for you shall be the one who is destroyed. You are cruel, merciless and a terror to all that lives. The world will be a better place with you gone!"
						[/message]
						[message]
							speaker=Sister Theta
							message= _ "To feed your greed and hunger you have terrorized all that is good. You have disturbed the rest of the brave defenders of Knalga. Now, your evil reign shall be brought to an end."
						[/message]
						[message]
							speaker=Malifor
							message= _ "Fools! Don't think it's so easy to kill me. Your corpses shall all soon be serving me. Fall on them, my hordes!"
						[/message]
					[/then]
				[/if]
			# This piece turns castles at the side of great chamber into road to prevent recruiting or falling back to them if the player comes
			# from that direction
                [if]
                    [variable]
                        name=chamber_of_death
                        equals=visited
                    [/variable]
                    [then]
                        [terrain]
                            x=19,19,19,9,9
                            y=2,3,4,3,4
                            terrain=Rr
                        [/terrain]
                    [/then]
                [/if]
            [/then]
        [/if]
		{CLEAR_VARIABLE open_the_door}
    [/event]

# Malifor can be succesfuly killed only by white mages, all other units only cause him to respawn somewhere on the map,
# this event handles that assumption
    [event]
        name=die
        first_time_only=no
        [filter]
            id=Malifor
        [/filter]

# Over the course of the scenario the player can have following units, since outcome of the event depends on 
# which unit deals the killing blow we need to make sure we cover all of them
# Dwarvish Lord,Dwarvish Dragonguard,Dwarvish Thunderguard,Dwarvish Steelclad,Dwarvish Fighter,Dwarvish Thunderer
# Thug,Poacher,Bandit,Highwayman,Footpad,Outlaw,Fugitive,Trapper
# Bowman,Master Bowman,Longbowman,Peasant,Woodsman,Spearman,Swordsman,Royal Guard,Pikeman,Javelineer,Halberdier,Arch Mage,Great Mage
# Wraith,Spectre
# Elvish Druid,Elvish Shyde,
# Drake Burner,Fire Drake,Drake Flare,Drake Flameheart
# White Mage,Mage of Light

# Above units can be grouped by a prevailing damage type, we need to know later which of the groups did the kill to choose
# proper dialogue and respawn location
	{VARIABLE malifor_died_by nothing}
	{VARIABLE malifor_will_respawn_at_x 0}
	{VARIABLE malifor_will_respawn_at_y 0}
	# First lets filter out all dwarves, that covers
	# Dwarvish Lord,Dwarvish Dragonguard,Dwarvish Thunderguard,Dwarvish Steelclad,Dwarvish Fighter,Dwarvish Thunderer
		[if]
			[variable]
				name=second_unit.race
				equals=Dwarf
			[/variable]
			[then]
				{VARIABLE malifor_died_by axe}
				{VARIABLE malifor_will_respawn_at_x 23}
				{VARIABLE malifor_will_respawn_at_y 4}
			[/then]
		[/if]
	# In second step we cover all lawful human and undead units 
	# Bowman,Master Bowman,Longbowman,Peasant,Woodsman,Spearman,Swordsman,Royal Guard,Pikeman,Javelineer,Halberdier,Arch Mage,Great Mage
	# Wraith,Spectre
	# White Mage,Mage of Light
		[if]
			[variable]
				name=second_unit.race
				equals=Human
			[/variable]
			[variable]
				name=second_unit.alignment
				equals=lawful
			[/variable]
			[or]
				[variable]
					name=second_unit.race
					equals=Undead
				[/variable]
			[/or]
			[then]
				{VARIABLE malifor_died_by blade}
				{VARIABLE malifor_will_respawn_at_x 14}
				{VARIABLE malifor_will_respawn_at_y 4}
			[/then]
		[/if]
	# Since outcome is different for archers we overwride things set for them previously, add chaotic humans and elves to the mix
	# Thug,Poacher,Bandit,Highwayman,Footpad,Outlaw,Fugitive,Trapper
	# Bowman,Master Bowman,Longbowman
	# Elvish Druid,Elvish Shyde
		[if]
			[variable]
				name=second_unit.race
				equals=Human
			[/variable]
			[and]
				[variable]
					name=second_unit.usage
					equals=archer
				[/variable]
				[or]
					[variable]
						name=second_unit.alignment
						equals=chaotic
					[/variable]
				[/or]
			[/and]
			[or]
				[variable]
					name=second_unit.race
					equals=Elf
				[/variable]
			[/or]
			[then]
				{VARIABLE malifor_died_by arrow}
				{VARIABLE malifor_will_respawn_at_x 5}
				{VARIABLE malifor_will_respawn_at_y 2}
			[/then]
		[/if]
	# Filtering out the single drake and overwriting red mage
	# Drake Burner,Fire Drake,Drake Flare,Drake Flameheart
	# Arch Mage,Great Mage
		[if]
			[variable]
				name=second_unit.description
				equals=Krash
			[/variable]
			[or]
				[variable]
					name=second_unit.description
					equals=Camerlin
				[/variable]
			[/or]
			[then]
				{VARIABLE malifor_died_by fire}
				{VARIABLE malifor_will_respawn_at_x 30}
				{VARIABLE malifor_will_respawn_at_y 11}
			[/then]
		[/if]
	# And finaly overwriting the white mages and calling scenario end
	# White Mage,Mage of Light
		[if]
			[variable]
				name=second_unit.description
				equals=Father Marcus
			[/variable]
			[or]
				[variable]
					name=second_unit.description
					equals=Sister Theta
				[/variable]
			[/or]
			[then]
			    [message]
					speaker=Malifor
					message= _ "AHHHHHH! YOU BLASTED MAGE!"
				[/message]
				[message]
					speaker=Tallin
					message= _ "Good. We finally got him. He is just dissolving."
				[/message]
				[message]
					speaker=Malifor
					message= _ "Curses on you you blasted mages, curses on you you blasted dwarves, curses on you you blasted humans, and CURSES ON YOU YOU BLASTED TALLIN! MAY YOUR MISERABLE LIVES BE FULL OF TORTURE! MAY YOUR PEOPLE NEVER BE FREE! MAY ALL YOUR NEAR AND DEAR DESERT YOU! MAY A THUNDERBOLT HIT YOUR HEAD! MAY..."
				[/message]
				[message]
					speaker=Tallin
					message= _ "May you shut your ugly mouth and hurry up and die."
				[/message]
				[message]
					speaker=Malifor
					message= _ "MAY THE EARTH OPEN UP AND SWALLOW YOU! MAY ALL YOUR TEETH FALL OUT! MAY YOU BECOME A WEAK SKINNY OLD MAN! MAY............."
				[/message]
				[message]
					speaker=second_unit
					message= _ "Finally! He has been reduced to dust."
				[/message]
				[message]
					speaker=Tallin
					message= _ "At last! Victory is ours! Good work, men!"
				[/message]
				[message]
					speaker=Father Marcus
					message= _ "So, where to now, Tallin?"
				[/message]
				[message]
					speaker=Tallin
					message= _ "Now, let's get back to the dwarves and see what progress they have made in forging us weapons."
				[/message]
				{CLEAR_VARIABLE malifor_will_respawn_at_x}
				{CLEAR_VARIABLE malifor_will_respawn_at_y}
				{CLEAR_VARIABLE malifor_died_by}
				[endlevel]
					result=victory
					bonus=yes
				[/endlevel]
			[/then]
		[/if]

	# If Malifor wasn't killed by white mages respawn him at the location set previously and give him some extra gold
        [unit]
            type=Ancient Lich
            id=Malifor
            user_description= _ "Malifor"
            profile=portraits/Malifor.jpg
            canrecruit=yes
            side=2
            recruit=Skeleton,Skeleton Archer
            x=$malifor_will_respawn_at_x
            y=$malifor_will_respawn_at_y
        [/unit]
        [gold]
            side=2
            amount=300
        [/gold]
        [terrain]
            x=13,14
            y=14,14
            terrain=Uu
        [/terrain]

	# Malifor was killed by dwarves	
		[if]
			[variable]
				name=malifor_died_by
				equals=axe
			[/variable]
			[then]
				[message]
					speaker=Malifor
					message= _ "HAHAHAHAHA, FOOLS, YOU THINK YOU CAN KILL ME?"
				[/message]
				{FLASH}
				[message]
					speaker=Malifor
					message= _ "HAHAHAHAHAHAHA!"
				[/message]
				[message]
					speaker=Tallin
					message= _ "What the...!"
				[/message]
				[message]
					speaker=second_unit
					message= _ "How can it be?! Our axes and hammers are failing."
				[/message]
				[message]
					speaker=Tallin
					message= _ "Blast it! Now where did he go? Let's find him and try something else!"
				[/message]
			[/then]
		[/if]
	# Malifor was killed by units with main slashing damage
		[if]
			[variable]
				name=malifor_died_by
				equals=blade
			[/variable]
			[then]
				[message]
					speaker=Malifor
					message= _ "HAHAHAHAHAHA, DEATH HAS NO EFFECT ON ME YOU FOOLS!"
				[/message]
				{FLASH}
				[message]
					speaker=Malifor
					message= _ "HAHAHAHAHA, I CAN NEVER BE DESTROYED!"
				[/message]
				[message]
					speaker=Tallin
					message= _ "Oh yes you will! But... how?"
				[/message]
				[message]
					speaker=second_unit
					message= _ "Well, it sure isn't gonna be done with a blade."
				[/message]
				[message]
					speaker=Tallin
					message= _ "And look, he's gone. Now we gotta find him all over again!"
				[/message]
			[/then]
		[/if]
	# Malifor was killed by archers or blunt damage dealers
		[if]
			[variable]
				name=malifor_died_by
				equals=arrow
			[/variable]
			[then]
		        [message]
					speaker=Malifor
					message= _ "HAHAHAHAHAHA, YOUR IDIOCY AMUSES ME GREATLY!"
				[/message]
				{FLASH}
				[message]
					speaker=Malifor
					message= _ "COME AND GET ME!"
				[/message]
				[message]
					speaker=Tallin
					message= _ "Geez, how are we going to kill him?"
				[/message]
				[message]
					speaker=second_unit
					message= _ "Well, obviously clubs and arrows won't work."
				[/message]
				[message]
					speaker=Tallin
					message= _ "Oh darn, he disappeared. Let's find him and try a different weapon."
				[/message]
			[/then]
		[/if]
	# Malifor was burned with fire
		[if]
			[variable]
				name=malifor_died_by
				equals=fire
			[/variable]
			[then]
				[message]
					speaker=Malifor
					message= _ "HAHAHAHAHAHA, I AM IMMORTAL!"
				[/message]
				{FLASH}
				[message]
					speaker=Malifor
					message= _ "YOU PUNY MORTALS SHALL SOON BE SERVING ME!"
				[/message]
				[message]
					speaker=Camerin
					message= _ "That blasted skeleton! Even fire has no affect on him!"
				[/message]
				[message]
					speaker=Tallin
					message= _ "Look, he disappeared again. Let's find him and try using a different weapon on him."
				[/message]
			[/then]
		[/if]
	# Again, white mages might not been freed yet, in that case folowing dialogue looks absurd.
		[if]
			[have_unit]
				id=Father Marcus
			[/have_unit]
			[have_unit]
				id=Sister Theta
			[/have_unit]
			[then]
				[message]
					speaker=Father Marcus
					message= _ "I see now. It is impossible to destroy him by ordinary means."
				[/message]
				[message]
					speaker=Tallin
					message= _ "Then how are we going to destroy him? Surely there must be a way."
				[/message]
				[message]
					speaker=Father Marcus
					message= _ "Yes, I think there is, but only myself or Theta have the means to do it. Come on Theta, let's destroy that old skeleton."
				[/message]
				[message]
					speaker=Sister Theta
					message= _ "Yeah, I can't wait to get my hands on that bastard!"
				[/message]
				[message]
					speaker=Father Marcus
					message= _ "That was very unladylike of you."
				[/message]
				[message]
					speaker=Sister Theta
					message= _ " *giggle* Sorry."
				[/message]
			[/then]
		[/if]
	[/event]

    [event]
        name=victory
        {CLEAR_VARIABLE back_door_opened}
		{CLEAR_VARIABLE main_door_opened}
		{CLEAR_VARIABLE spider_door_opened}
		{CLEAR_VARIABLE confronted_malifor}
        {CLEAR_VARIABLE treasury_alerted}
		{CLEAR_VARIABLE chamber_of_death}
		
    [/event]
