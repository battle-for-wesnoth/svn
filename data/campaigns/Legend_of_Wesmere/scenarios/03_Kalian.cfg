#textdomain wesnoth-low

#TODO make the ugly map border nicer

[scenario]
    id=03_Kalian
    name= _ "Ka'lian under attack"
    next_scenario=04_Elvish_Treasury

    {LOW_MAP  Kalian.map}
    {LOW_MASK 03_Kalian.mask}
    [event]
        name=prestart
        # make some part of the map unpassable
        [terrain]
            terrain=_off^_usr #wmllint: noconvert
            x=0-45,0-9 , 0-45
            y=0-5 ,0-44,39-44
        [/terrain]
    [/event]

    {TURNS 5 7 9}

    {INTRO_AND_SCENARIO_MUSIC northerners.ogg elvish-theme.ogg}
    {EXTRA_SCENARIO_MUSIC siege_of_laurelmor.ogg}
    {EXTRA_SCENARIO_MUSIC wanderer.ogg}
    #TODO add some more titles   
    {EXTRA_SCENARIO_MUSIC suspense.ogg}

    {DEFAULT_SCHEDULE}

    [story]
        [part]
            #TODO ESR please check the prosa. 
            #I wanted to pronounce that Kalenz isnt't right there now.
            story= _ "Kalenz and his band finally were on their way to the Ka'lian, but things were not as they had hoped..."
            delay=4000
        [/part]
        [part]
            delay=4000
            show_title=yes
            {TO_KALIAN}
        [/part]
    [/story]

    #### Player's code ####

    [event]
        name=prestart
        [store_unit]
            variable=kalenz
            kill=yes
            [filter]
                race=elf
                [not]
                    id=Galtrid
                [/not]
            [/filter]
        [/store_unit]

        [store_gold]
            side=1
            variable=kalenz_gold
        [/store_gold]

        [modify_side]
            side=1
#ifdef EASY
            gold=200
#endif
#ifdef NORMAL
            gold=210
#endif
#ifdef HARD
            gold=220
#endif
        [/modify_side]

    [/event]

    [side]
        side=1
        controller=human
        team_name=kalenz
        no_leader=yes
        recruit={ELVES}
        save_id=Kalenz
        fog=yes
        
        {GOLD 300 200 100}

        [unit]
            {GALTRID}
            # wmllint: recognize Galtrid
            x=33
            y=26
        [/unit]
    [/side]
    {STARTING_VILLAGES_ALL 1}

    #### /Player's code ####


    #### Kalenz arrives ####

    [event]
        name="time over" 

        [modify_turns]
###    {TURNS 35 30 25}
#ifdef EASY
            add=35
#endif
#ifdef NORMAL
            add=30
#endif
#ifdef HARD
            add=25
#endif
        [/modify_turns]

        {MODIFY_UNIT (side=1 
                      x=1-99 
                      y=1-99) side 2}

        [store_villages]
            variable=villages
            owner_side=1
        [/store_villages]

        {FOREACH villages village}
            [capture_village]
                side=2
                x=$villages[$village].x
                y=$villages[$village].y
            [/capture_village]
            {NEXT village}

        {CLEAR_VARIABLE villages}

        {FOREACH kalenz elf}
            [unstore_unit]
                variable=kalenz[$elf]
                x=recall
                y=recall
            [/unstore_unit]

#            [message]
#                id=Galtrid
#                message="blah $kalenz[$elf].id"
#            [/message]

            {NEXT elf}

        {CLEAR_VARIABLE kalenz}

#        {RECALL_KALENZ 43 15}

        [recall]
            id=Kalenz
            x=43
            y=15
        [/recall]

        {RECALL_LOYALS}

        [store_gold]
            variable=galdrid_gold
            side=1
        [/store_gold]

        [modify_side]
            side=1
            gold=$kalenz_gold
        [/modify_side]

        [modify_side]
            side=2
            gold=$galdrid_gold
        [/modify_side]
            
        {CLEAR_VARIABLE kalenz_gold}
        {CLEAR_VARIABLE galdrid_gold}

        [objectives]
            side=1
            [objective]
                description= _ "Defeat all enemy leaders"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Kalenz"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Landar"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Galtrid"
                condition=lose
            [/objective]
            [objective]
                description= _ "Turns run out"
                condition=lose
            [/objective]
            note={EARLY_FINISH_BONUS_NOTE}
        [/objectives]

        [message]
            #TODO ESR 
            id=Kalenz
            message= _ "Oh no! The Ka'lian is under attack! We must help them!"
        [/message]
        [message]
            #TODO ESR
            id=Galtrid
            message= _ "Are you our army's vanguard? Hurry, we are under attack!"
        [/message]
        [message]
            #TODO ESR
            id=Kalenz
            message= _ "No, we are fleeing an attack on our home, northeast of here. Time enough for talk later; we must defeat these orcs together, or at least hold them off long enough for the humans to come to our aid."
        [/message]
        [message]
            #TODO ESR
            id=Galtrid
            message= _ "Then you have not heard. King Haldric has broken the treaty. The humans will not come to our help!"
        [/message]
        [message]
            id=Mutaf-uru
            message= _ "What's that? More meat for my troops? Get them!"
        [/message]

        [event]
            name="time over" 

            [message]
                id=Kalenz
                #TODO ESR enhance prose
                message= _ "We have lost for some reason!"
            [/message]
        [/event]
    [/event]

    #### /Kalenz arrives ####

    #wmllint: validate-off
    [side]
        side=2
        no_leader=yes
        controller=ai
        team_name=kalenz
        recruit={ELVES}
        #        
        {GOLD 0 0 0}

        [ai]
            recruitment_pattern=healer,archer,fighter,archer,fighter,archer,healer,scout
            villages_per_scout=10
            passive_leader=yes
            grouping=defensive
            caution=0.5
            aggression=0.0
        [/ai]
    [/side]

#    {RECALL_KALENZ 43 15}
    # wmllint: recognize Kalenz
#    [event]
#        name=prestart
#        {RECALL_LOYALS}
#        {CHECK_LANDAR}
#        # wmllint: recognize Landar
#    [/event]

    #### /Kalenz's code ####

#    [side]
#        side=2
#        no_leader=yes
#        team_name=kalenz
#        recruit={ELVES}
#        [unit]
#            {GALTRID}
#            # wmllint: recognize Galtrid
#            x=33
#            y=26
#        [/unit]
#    [/side]
 
    #wmllint: validate-on

    #### Side3 code ####
    [side]
        side=3
        no_leader=yes
        team_name=orcs
        [unit]
            type=Orcish Warlord
            id=Mutaf-uru
            name= _ "Mutaf-uru"
            profile=portraits/orcs/warlord3.png
            canrecruit=yes
            x=17
            y=6
        [/unit]
#ifdef EASY
        recruit={ORCS1}, Orcish Crossbowman, Goblin Pillager, Goblin Knight
#endif
#ifdef NORMAL
        recruit={ORCS1}, Orcish Crossbowman, Goblin Pillager, Goblin Knight, Orcish Slayer, Goblin Impaler, Goblin Rouser, Orcish Warrior
#endif
#ifdef HARD
        recruit={ORCS1}, Orcish Crossbowman, Goblin Pillager, Goblin Knight, Orcish Slayer, Goblin Impaler, Goblin Rouser, Orcish Warrior
#endif
        {GOLD 150 280 460}
        {INCOME 4 8 12}
        [ai]
            {NO_SCOUTS}
            recruitment_ignore_bad_movement=yes
            recruitment_pattern=scout,fighter,fighter,archer,mixed fighter
        [/ai]
        [ai]
            time_of_day=dusk,first_watch,second_watch
            aggression=0.75
            caution=0.0
            grouping=offensive
        [/ai]
    [/side]
    [event]
        name=last breath
        [filter]
            id=Mutaf-uru
        [/filter]
        [message]
            speaker=unit
            message= _ "We die, but more come after us, Orcs will rule all!"
        [/message]
    [/event]
    #### /Side3 code ####

    [side]
        side=4
        no_leader=yes
        team_name=orcs
        [unit]
            type=Orcish Warlord
            id=Murudin
            name= _ "Murudin"
            canrecruit=yes
            x=11
            y=14
        [/unit]
#ifdef EASY
        recruit=Orcish Archer, Orcish Assassin, Orcish Grunt, Wolf Rider, Orcish Crossbowman, Goblin Pillager, Goblin Knight, Goblin Spearman
#endif
#ifdef NORMAL
        recruit=Orcish Archer, Orcish Assassin, Orcish Grunt, Wolf Rider, Orcish Crossbowman, Goblin Knight, Orcish Slayer, Goblin Pillager, Goblin Spearman, Orcish Warrior
#endif
#ifdef HARD
        recruit=Orcish Archer, Orcish Assassin, Orcish Grunt, Wolf Rider, Orcish Crossbowman, Goblin Knight, Goblin Pillager, Orcish Slayer, Goblin Spearman, Orcish Warrior
#endif
        {GOLD 200 360 500}
        {INCOME 4 8 12}
        [ai]
            villages_per_scout=3
            village_value=50
            scout_village_targeting=50
            recruitment_pattern=scout,scout,scout,fighter,archer,mixed fighter
        [/ai]
#disabled as long as the ai behaves strange
#        [ai]
#            recruitment_pattern=scout,scout,scout,fighter,fighter,archer,fighter,mixed fighter
#            villages_per_scout=3
#            village_value=50
#            scout_village_targeting=100
 #           scout_village_target=5
#            time_of_day=dusk,first_watch,second_watch
#            aggression=0.75
#            caution=0.0
#            grouping=offensive
#        [/ai]
    [/side]

    [event]
        name=prestart
        [objectives]
            [objective]
                description= _ "Death of Galtrid"
                condition=lose
            [/objective]
            [objective]
                description= _ "Turns run out"
                condition=win
            [/objective]
        [/objectives]
    [/event]

    [event]
        name=start

        [message]
            id=guard
            #TODO ESR 
            message= _ "Watch out! Someone is sneaking around in the mist."
        [/message]

        [message]
            id=orc_leader
            #TODO ESR 
            message= _ "Hand over your Citadel and we might spare you. Or at least you will have a quick and painless dead."
        [/message]

        [message]
            id=Galtrid
            #TODO ESR 
            message= _ "The Ka'lian is older than you foul creatures walk under the sun and it was never raided. It will still stand after the last of you beasts have vanished and your wrong doings are long forgotten."
        [/message]

        [message]
            id=orc_leader
            #TODO ESR 
            message= _ "Punch his arrogant words back down his throat!"
        [/message]

        [message]
            id=Galtrid
            #TODO ESR 
            message= _ "To the arms! Hopefully our vanguard will be finished at the treasury soon and come to our aid."
        [/message]
    [/event]

    [event]
        name=victory
        [message]
            id=Kalenz
            message= _ "We won! The Ka'lian is safe!"
        [/message]

        [sound]
            name=horse-canter.wav
        [/sound]

        [move_unit_fake]
            type=Elvish Scout
            x=44,42,40,34,32,31
            y=13,12,12,15,18,22
        [/move_unit_fake]

        #TODO Move Huraldur to characters?
        [unit]
            id=Huraldur
            name= _ "Huraldur"
            type=Elvish Scout
            side=1
            x=31
            y=22
            [modifications]
                {TRAIT_QUICK}
                {TRAIT_RESILIENT}
                {TRAIT_LOYAL}
            [/modifications]
            facing=se
        [/unit]

        [message]
            id=Huraldur
            message= _ "The elvish treasury is under attack! They need help desperately!"
        [/message]
        [message]
            id=Kalenz
            message= _ "Galtrid, your men are weary from long combat. Mine are fresher; I'll go."
        [/message]
        [message]
            id=Huraldur
            message= _ "Hurry! We were near overwhelmed as I left."
        [/message]
        [message]
            id=Galtrid
            message= _ "Yes, go, Kalenz, I'll guard the Ka'lian till our army returns from the front."
        [/message]
    [/event]

#    {campaigns/Legend_of_Wesmere/utils/deaths.cfg}
[/scenario]
