#textdomain wesnoth
# Side-limit macros for balancing AI behaviour. You can, for example
# give an AI side the possibility to recruit high level units but not to have
# too many of them at the same time.  Note: These generate events, so they need
# to be placed directly under your [scenario] tag, and not within an event
# such as start or prestart.

#define LIMIT_CONTEMPORANEOUS_RECRUITS SIDE FILTER LIMIT
    # Limit the number of units passing a specified filter that a side
    # can have simultaneously. When the number of matching units
    # side has reaches or exceeds LIMIT, that side is prevented from
    # recruiting more until the number of units of that type drops
    # below LIMIT again.
    #
    # Allow side 2 no more than 2 Troll Rocklobbers at a time
    #! {LIMIT_CONTEMPORANEOUS_RECRUITS 2 type="Troll Rocklobber" 2}
    [event]
        name=side turn
        first_time_only=no

        [if]
            [variable]
                name=side_number
                equals={SIDE}
            [/variable]

            [then]
                [store_unit]
                    [filter]
                        side={SIDE}
                        {FILTER}
                    [/filter]

                    kill=no
                    variable=LIMIT_CONTEMPORANEOUS_RECRUITS_temp
                [/store_unit]

                [if]
                    [variable]
                        name=LIMIT_CONTEMPORANEOUS_RECRUITS_temp.length
                        greater_than_equal_to={LIMIT}
                    [/variable]

                    [then]
                        [disallow_recruit]
                            side={SIDE}
                            {FILTER}
                        [/disallow_recruit]
                    [/then]

                    [else]
                        [allow_recruit]
                            side={SIDE}
                            {FILTER}
                        [/allow_recruit]
                    [/else]
                [/if]

                {CLEAR_VARIABLE LIMIT_CONTEMPORANEOUS_RECRUITS_temp}
            [/then]
        [/if]
    [/event]

    [event]
        name=recruit
        first_time_only=no

        [filter]
            side={SIDE}
            {FILTER}
        [/filter]

        [store_unit]
            [filter]
                side={SIDE}
                {FILTER}
            [/filter]

            kill=no
            variable=LIMIT_CONTEMPORANEOUS_RECRUITS_temp
        [/store_unit]

        [if]
            [variable]
                name=LIMIT_CONTEMPORANEOUS_RECRUITS_temp.length
                greater_than_equal_to={LIMIT}
            [/variable]

            [then]
                [disallow_recruit]
                    side={SIDE}
                    {FILTER}
                [/disallow_recruit]
            [/then]
        [/if]

        {CLEAR_VARIABLE LIMIT_CONTEMPORANEOUS_RECRUITS_temp}
    [/event]
#enddef

#define LIMIT_RECRUITS SIDE FILTER LIMIT
    # Limit the total number of units passing a specified filter that a given
    # side can recruit in the scenario.
    #
    # Allow side 2 no more than 1 Draug in the entire scenario
    #! {LIMIT_RECRUITS 2 type=Draug 1}
    [+variables]
        side_{SIDE}_limited_recruits_length=-1
    [/variables]

    [event]
        name=recruit
        first_time_only=yes

        [filter]
            side={SIDE}
            {FILTER}
        [/filter]

        {VARIABLE_OP side_{SIDE}_limited_recruits_length add 1}

        {VARIABLE_OP LIMIT_RECRUITS_temp1 format "side_{SIDE}_limited_recruits[$side_{SIDE}_limited_recruits_length|].type"}
        {VARIABLE $LIMIT_RECRUITS_temp1 {TYPE}}
        {CLEAR_VARIABLE LIMIT_RECRUITS_temp1}
    [/event]

    [event]
        name=recruit
        first_time_only=no

        [filter]
            side={SIDE}
            {FILTER}
        [/filter]

        {VARIABLE_OP LIMIT_RECRUITS_temp2 format "side_{SIDE}_limited_recruits[$side_{SIDE}_limited_recruits_length|].recruited"}
        {VARIABLE_OP $LIMIT_RECRUITS_temp2 add 1}
        {CLEAR_VARIABLE LIMIT_RECRUITS_temp2}

        {FOREACH side_{SIDE}_limited_recruits i}
        [if]
            [variable]
                name=side_{SIDE}_limited_recruits[$i].type
                equals={TYPE}
            [/variable]

            [variable]
                name=side_{SIDE}_limited_recruits[$i].recruited
                equals={LIMIT}
            [/variable]

            [then]
                [disallow_recruit]
                    side={SIDE}
                    {FILTER}
                [/disallow_recruit]
            [/then]
        [/if]
        {NEXT i}
    [/event]
#enddef
