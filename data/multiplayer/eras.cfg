#textdomain wesnoth-multiplayer
#define RANDOM_SIDE
    [multiplayer_side]
        id=Random
        name= _"Random"
        image="units/random-dice.png"
        {MAGENTA_IS_THE_TEAM_COLOR}
        random_faction=yes
    [/multiplayer_side]
#enddef

#define QUICK_4MP_LEADERS
    # This makes all leaders with 4 MP receive the quick trait.

    [event]
        name=prestart

        [store_unit]
            [filter]
                canrecruit=yes

                [filter_wml]
                    max_moves=4
                [/filter_wml]
            [/filter]

            kill=yes
            variable=leaders_to_make_quick
        [/store_unit]

        {FOREACH leaders_to_make_quick i}
            [set_variables]
                name=leaders_to_make_quick[$i].modifications
                mode=merge

                [literal]
                    {TRAIT_QUICK}
                [/literal]
            [/set_variables]

            {CLEAR_VARIABLE leaders_to_make_quick[$i].max_moves,leaders_to_make_quick[$i].moves,leaders_to_make_quick[$i].max_hitpoints,leaders_to_make_quick[$i].hitpoints}

            [unstore_unit]
                variable=leaders_to_make_quick[$i]
            [/unstore_unit]
        {NEXT i}

        {CLEAR_VARIABLE leaders_to_make_quick}
    [/event]
#enddef

#define TURNS_OVER_ADVANTAGE
    [event]
        name=time over
        [lua]
            code=<<
                local function all_sides()
                    local function f(s, i)
                        i = i + 1
                        local t = wesnoth.get_side(i)
                        return t and i, t
                    end
                    return f, nil, 0
                end

                local income_factor = 5
                local levelup_factor = 5

                local side_num = -1
                local income_score = -1
                local unit_score = -1
                local gold_score = -1
                local total_score = -1
                for side, team in all_sides() do
                    local income = team.total_income * income_factor
                    local units = 0
                    -- Calc the total unit-score here
                    for i, unit in ipairs( wesnoth.get_units { side = side } ) do
                        units = units + unit.__cfg.cost
                    end
                    -- Up to here
                    local total = units + team.gold + income
                    if total > total_score then
                        side_num = side
                        income_score = income
                        unit_score = units
                        gold_score = team.gold
                        total_score = total
                    end
                end
                wesnoth.fire("message", { message =
                    string.format("Side %d has the advantage with:\nIncome score %d\nUnit score %d\nGold %d\n\nGrand total %d",
                        side_num,
                        income_score,
                        unit_score,
                        gold_score,
                        total_score),
                    speaker = "narrator",
                    image = "wesnoth-icon.png" })
            >>
        [/lua]
    [/event]
#enddef

[era]
    id=era_default
    name= _ "Default"

    {RANDOM_SIDE}
    {multiplayer/factions/loyalists-default.cfg}
    {multiplayer/factions/rebels-default.cfg}
    {multiplayer/factions/northerners-default.cfg}
    {multiplayer/factions/undead-default.cfg}
    {multiplayer/factions/knalgans-default.cfg}
    {multiplayer/factions/drakes-default.cfg}

    {QUICK_4MP_LEADERS}
    {TURNS_OVER_ADVANTAGE}
[/era]

[era]
    id=era_heroes
    name= _ "Age of Heroes"

    {RANDOM_SIDE}
    {multiplayer/factions/loyalists-aoh.cfg}
    {multiplayer/factions/rebels-aoh.cfg}
    {multiplayer/factions/northerners-aoh.cfg}
    {multiplayer/factions/undead-aoh.cfg}
    {multiplayer/factions/knalgans-aoh.cfg}
    {multiplayer/factions/drakes-aoh.cfg}

    {QUICK_4MP_LEADERS}
[/era]
